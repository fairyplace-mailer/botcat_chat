name: Vercel Preview Comment

on:
  deployment_status:

permissions:
  contents: read
  pull-requests: write

jobs:
  comment:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Comment Vercel preview status on PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.deployment.sha }}
          STATE: ${{ github.event.deployment_status.state }}
          ENV_URL: ${{ github.event.deployment_status.environment_url }}
          LOG_URL: ${{ github.event.deployment_status.log_url }}
          DESCRIPTION: ${{ github.event.deployment_status.description }}
        run: |
          set -euo pipefail

          # We care mostly about Vercel preview deployments.
          # Vercel usually reports environment=Preview/preview.
          ENV_NAME="${{ github.event.deployment.environment }}"
          if [ "${ENV_NAME}" != "preview" ] && [ "${ENV_NAME}" != "Preview" ]; then
            echo "Skip: environment=${ENV_NAME}"
            exit 0
          fi

          if [ -z "${SHA}" ]; then
            echo "Missing SHA in deployment event" >&2
            exit 1
          fi

          # Find open PR for this head SHA
          PR_NUMBER=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "repos/${REPO}/commits/${SHA}/pulls" \
            --jq 'map(select(.state=="open"))[0].number // empty')

          if [ -z "${PR_NUMBER}" ]; then
            echo "No open PR found for sha=${SHA}. Nothing to comment."
            exit 0
          fi

          MARKER="<!-- botcow:vercel-preview -->"

          URL_LINE=""
          if [ -n "${ENV_URL}" ]; then
            URL_LINE="Preview: ${ENV_URL}"
          fi

          EXTRA=""
          if [ -n "${LOG_URL}" ]; then
            EXTRA="${EXTRA}
Logs: ${LOG_URL}"
          fi
          if [ -n "${DESCRIPTION}" ]; then
            EXTRA="${EXTRA}
Note: ${DESCRIPTION}"
          fi

          BODY="$MARKER

${URL_LINE}
Status: ${STATE}${EXTRA}"

          gh api \
            -X POST \
            "repos/${REPO}/issues/${PR_NUMBER}/comments" \
            -f body="$BODY"
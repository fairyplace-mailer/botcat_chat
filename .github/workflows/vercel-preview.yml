name: Vercel Preview Comment

on:
  check_run:
    types: [completed]

permissions:
  contents: read
  pull-requests: write

jobs:
  comment:
    if: |
      github.event.check_run.name != '' &&
      (contains(github.event.check_run.name, 'Vercel') || github.event.check_run.app.slug == 'vercel')
    runs-on: ubuntu-latest
    steps:
      - name: Prepare variables
        id: vars
        env:
          CHECK_NAME: ${{ github.event.check_run.name }}
          CONCLUSION: ${{ github.event.check_run.conclusion }}
          DETAILS_URL: ${{ github.event.check_run.details_url }}
          SHA: ${{ github.event.check_run.head_sha }}
        run: |
          echo "sha=${SHA}" >> $GITHUB_OUTPUT
          echo "conclusion=${CONCLUSION}" >> $GITHUB_OUTPUT
          echo "details_url=${DETAILS_URL}" >> $GITHUB_OUTPUT

      - name: Find PRs for SHA
        id: prs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          SHA: ${{ steps.vars.outputs.sha }}
        run: |
          prs_json=$(gh api -H "Accept: application/vnd.github+json" "/repos/${REPO}/commits/${SHA}/pulls")
          echo "$prs_json" > prs.json
          count=$(jq 'length' prs.json)
          echo "count=${count}" >> $GITHUB_OUTPUT
          if [ "$count" -eq 0 ]; then
            echo "No PRs found for sha=${SHA}." >&2
            exit 0
          fi
          number=$(jq -r '.[0].number' prs.json)
          echo "number=${number}" >> $GITHUB_OUTPUT

      - name: Upsert comment on PR
        if: ${{ steps.prs.outputs.count != '0' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.prs.outputs.number }}
          CONCLUSION: ${{ steps.vars.outputs.conclusion }}
          DETAILS_URL: ${{ steps.vars.outputs.details_url }}
          SHA: ${{ steps.vars.outputs.sha }}
        run: |
          marker="<!-- botcow:vercel-preview -->"

          status="${CONCLUSION}"
          if [ -z "$status" ] || [ "$status" = "null" ]; then
            status="completed"
          fi

          preview_url="$DETAILS_URL"

          body=$(cat <<EOF
          ${marker}
          **Vercel Preview**

          - Status: \\`${status}\\`
          - Preview: ${preview_url}
          - Details: ${DETAILS_URL}
          - Commit: ${SHA}
          EOF
          )

          comments=$(gh api -H "Accept: application/vnd.github+json" "/repos/${REPO}/issues/${PR_NUMBER}/comments?per_page=100")
          existing_id=$(echo "$comments" | jq -r --arg m "$marker" '.[] | select(.body | contains($m)) | .id' | head -n 1)

          if [ -n "$existing_id" ] && [ "$existing_id" != "null" ]; then
            gh api -X PATCH -H "Accept: application/vnd.github+json" "/repos/${REPO}/issues/comments/${existing_id}" -f body="$body" > /dev/null
            echo "Updated comment id=${existing_id} on PR #${PR_NUMBER}."
          else
            gh api -X POST -H "Accept: application/vnd.github+json" "/repos/${REPO}/issues/${PR_NUMBER}/comments" -f body="$body" > /dev/null
            echo "Created comment on PR #${PR_NUMBER}."
          fi

**Техническое задание**

BOTCAT™ CONSULTANT

**Версия:** 1.0 (обновлено под этап 1: web chat v1.0)

---

## 0. Вводная часть

### 0.1. Цель документа

Зафиксировать требования к проекту BotCat™ Consultant и порядок этапов реализации.

### 0.2. Этапы реализации (обновлено)

**Этап 1 — Web chat (v1.0): https://fairyplace.net/chat**

- Один чат.
- История чата хранится **только в памяти UI** (без БД на этапе 1).
- При перезагрузке страницы история **теряется**.
- На экране есть кнопка **New Chat** (сбрасывает чат без перезагрузки страницы).
- Общение с OpenAI через backend `/api/chat` строго **SSE**.
- Поддержка PWA.
- Модели OpenAI на этапе 1 используются **те, которые уже указаны в проекте** (env.ts).

**Этап 2 — Интеграция с соцсетями FairyPlace™**

- WhatsApp
- Instagram
- Telegram
- Messenger
- Viber

**Этап 3 — Web chat PRO (v2.0): https://fairyplace.net/chat_pro**

- Один чат.
- История чата хранится **только в памяти UI**.
- При перезагрузке страницы история **теряется**.
- В UI есть вкладка/панель (как в ChatGPT). На панели:
  - лого;
  - кнопка **New Chat**;
  - кнопки **Download PDF** (скачивание PDF предыдущих бесед);
  - кнопка открытия меню авторизации (примерно как в ChatGPT).
- Чат активируется **только после регистрации/авторизации**.
- На этапе 3 используются **более продвинутые модели OpenAI** (уточняются перед стартом этапа 3).

Технические детали этапа 3 будут уточнены отдельно перед началом работ.

---

## 1. Главная страница https://fairyplace.net (обновлено)

На главной странице должны быть:

- лого;
- общая информация **на английском**;
- кнопки перехода на страницы:
  - v1.0 модель: `/chat`
  - v2.0 модель: `/chat_pro`
- кнопка перехода на официальный сайт: https://fairyplace.biz
- кнопки отправки почты:
  - `order@fairyplace.net`
  - `support@fairyplace.net`
- кнопки перехода в соцсети FairyPlace™.

---

## 2. Общая концепция

BotCat™ Consultant — AI‑сервис, который:

- общается с клиентами на сайте `fairyplace.net`;
- консультирует по дизайну (в рамках skills);
- работает через backend (Vercel) с OpenAI;
- поддерживает PWA;
- умеет работать со ссылками и файлами через Vercel Blob.

---

## 3. Архитектура системы (упрощение под этап 1)

На **этапе 1** обязательны только:

- UI (Next.js)
- Backend API (Next.js route handlers)
- OpenAI
- Vercel Blob
- PWA

Компоненты для стенограмм/HTML/PDF/почты/БД/Drive остаются в документе как часть общей архитектуры, но **не являются обязательными для готовности этапа 1**, если это прямо не требуется отдельной задачей.

---

## 4. Backend API specification

### 4.1. POST /api/chat (строго SSE)

Назначение: основной endpoint для общения веб‑чата с BotCat через OpenAI (SSE stream).

**Request**

- Method: POST
- Headers: `Content-Type: application/json`

Body (пример):

```json
{
  "chatName": null,
  "message": "Текст сообщения пользователя...",
  "attachments": [
    {
      "blobKey": "uploads/...",
      "fileName": "plan.pdf",
      "mimeType": "application/pdf",
      "fileSizeBytes": 123456,
      "blobUrl": "https://..."
    }
  ],
  "client": {
    "sessionId": "c7f3d5c0-6f0c-4c5a-9f3b-2f3e...",
    "userAgent": "Mozilla/5.0 ...",
    "ipHash": "sha256:..."
  }
}
```

Поля:

- `chatName`: `string | null`
  - `null` для первого сообщения в сессии;
  - строка — для продолжения существующей беседы.
- `message`: `string` (обязательно)
- `attachments[]`: список файлов, **уже загруженных в Blob** (см. раздел 5)
- `client`: метаданные клиента

**Response**

- Status: `200 OK`
- Content-Type: `text/event-stream`

События SSE:

- токены/чанки текста модели
- финальное событие:

```json
{
  "type": "final",
  "chatName": "FP_2025-01-01_12-00-01_abc123",
  "messageId": "FP_2025-01-01_12-00-01_abc123__b_001"
}
```

Ошибки:

- 400 — некорректный запрос
- 500 — ошибка сервера / OpenAI

---

## 5. Файлы и вложения (границы ответственности)

### 5.1. USER → UI → Blob (прямая загрузка)

- Пользователь выбирает файл.
- UI **напрямую** загружает его в Vercel Blob.
- UI получает `blobUrl` (и/или `blobKey`).
- UI отправляет в `/api/chat` только ссылки/метаданные (не бинарные данные).

### 5.2. OpenAI → UI → Backend → Blob (файлы, сгенерированные моделью)

- Если OpenAI сгенерировал данные (например, base64 изображения), UI передаёт это на backend.
- Backend:
  - преобразует данные в файл (если нужно),
  - сохраняет в Blob,
  - возвращает UI ссылку (`blobUrl`) для отображения и дальнейшей работы.

---

## 6. PWA (обязательно)

UI должен:

- иметь `manifest.json`
- иметь service worker
- поддерживать "Install app"
- работать в `standalone`
- иметь иконки 192/512 px

---

## 7. Логика завершения диалога (обновлено)

Диалог считается оконченным, если:

- пользователь вышел из чата, или
- пользователь неактивен более 1 часа.

Если пользователь продолжает общение после 1 часа+ неактивности:

- начинается новая стенограмма с **новым** `chatName`
- перед первой фразой пользователя в новой стенограмме добавляется пометка: **"Продолжение‑N"**

**Важно:**

- BotCat **не принимает решений** о завершении диалога.
- Решение принимает **только backend‑оркестратор**.
- Когда оркестратор решает завершить диалог, он даёт BotCat команду:

`SYSTEM: finalize_transcript_now`

- Только после этой команды (и только если `sendToInternal=true` по логике оркестратора) происходит вызов `/api/bot/webhook`.

---

## 8. Письма клиентам (обновлено)

На текущем этапе и в текущей версии ТЗ:

- бот **не отправляет письма клиентам**
- логика email‑рассылок клиентам из предыдущей редакции ТЗ **не применяется**

(Внутренние процессы/уведомления можно добавить позже отдельной задачей и отдельным разделом ТЗ.)

---

## 9. Definition of Done (DoD) — этап 1 (обновлено)

Этап 1 считается выполненным, если:

- главная страница `https://fairyplace.net` соответствует разделу 1;
- чат доступен на `https://fairyplace.net/chat`;
- чат работает как мессенджер (пузырьки, скролл, вложения, индикаторы);
- есть кнопка **New Chat**;
- `/api/chat` работает **строго через SSE**;
- загрузка файлов работает через Vercel Blob (прямая загрузка UI → Blob);
- PWA работает (manifest, service worker, install prompt).

---

## 10. MANDATORY приложения (сохранены)

Разделы **MANDATORY_1** и **MANDATORY_2** ниже по документу остаются обязательными правилами поведения BotCat и техническими требованиями.

> Примечание: если MANDATORY‑разделы противоречат обновлённым разделам 0–9, приоритет имеют разделы 0–9 как актуальная редакция ТЗ для данного репозитория.
